<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Reimbursement Portal</title>
  <script src="https://unpkg.com/pdf-lib"></script>
  <style>
    body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; margin: 2rem; background-color: #f4f4f9; color: #333; }
    h1, h2, h3 { color: #2c3e50; }
    .hidden { display: none; }
    .form-section, .receipt-entry { margin-bottom: 1.5rem; padding: 1.5rem; border: 1px solid #ddd; border-radius: 8px; background-color: #fff; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
    label { display: block; margin-top: 1rem; font-weight: bold; color: #555; }
    input, select, textarea { width: 100%; padding: 0.75rem; margin-top: 0.3rem; border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box; }
    button { background-color: #3498db; color: white; padding: 0.75rem 1.5rem; margin-top: 1rem; border: none; border-radius: 4px; cursor: pointer; font-size: 1rem; transition: background-color 0.3s; }
    button:hover { background-color: #2980b9; }
    button:disabled { background-color: #a9a9a9; cursor: not-allowed; }
    #referenceNumber { margin-top: 1.5rem; font-weight: bold; white-space: pre-line; padding: 1rem; border-radius: 4px; background-color: #eafaf1; border: 1px solid #b8e9c9; }
  </style>
</head>
<body>
  <h1>Reimbursement Portal</h1>
  <div id="form">
    <h2>Submit Reimbursement Request</h2>
    <form id="reimbursementForm">
      <div class="form-section">
        <label>Full Name</label><input type="text" name="fullName" required>
        <label>Email Address</label><input type="email" name="email" required>
        <label>Project Lead or Project Name</label><input list="projectNumbers" name="project" required placeholder="Start typing or click to browse"><datalist id="projectNumbers"><option value="Christine LUTRINGER – AHCD 2025 – P0189"><option value="Vincent CHETAIL – NCCR / Migration Governance – S2334"></datalist>
        <label>IBAN</label><input type="text" name="iban" placeholder="e.g., CH9300762011623852957">
        <label>Bank Account Number (non-IBAN)</label><input type="text" name="accountNumber">
        <label>Bank Code</label><input type="text" name="bankCode">
        <label>Bank Name</label><input type="text" name="bankName">
        <label>Your Address</label><textarea name="address"></textarea>
      </div>

      <h3>Receipts</h3>
      <div id="receipts"></div>
      <button type="button" onclick="addReceipt()">Add Receipt</button>
      <br><br>
      <button type="submit">Submit</button>
    </form>
    <div id="referenceNumber" class="hidden"></div>
  </div>

  <script>
    let receiptIndex = 0;
    const { PDFDocument } = PDFLib; // Get the PDFDocument class from the library

    function addReceipt() {
      const container = document.createElement('div');
      container.classList.add('receipt-entry');
      // This creates the full block for each receipt entry
      container.innerHTML = `
        <h4>Receipt ${receiptIndex + 1}</h4>
        <label>Upload Receipt PDF</label>
        <input type="file" name="receiptFile${receiptIndex}" accept=".pdf" required>
        
        <label>Currency</label>
        <input type="text" name="currency${receiptIndex}" placeholder="e.g., CHF" required>
        
        <label>Amount</label>
        <input type="number" name="amount${receiptIndex}" step="0.01" required>
        
        <label>Expense Type</label>
        <select name="type${receiptIndex}" required>
          <option value="">Select a type</option><option value="Travel">Travel</option><option value="Accommodation">Accommodation</option><option value="Meals">Meals</option><option value="Supplies">Supplies</option><option value="Honorarium">Honorarium</option><option value="Other">Other</option>
        </select>
      `;
      document.getElementById('receipts').appendChild(container);
      receiptIndex++;
    }

    // Helper function to convert a Uint8Array to a Base64 string
    function uint8ArrayToBase64(bytes) {
      let binary = '';
      const len = bytes.byteLength;
      for (let i = 0; i < len; i++) {
        binary += String.fromCharCode(bytes[i]);
      }
      return window.btoa(binary);
    }

    document.getElementById('reimbursementForm').addEventListener('submit', async function (e) {
      e.preventDefault();
      
      console.log("--- Submit button clicked. Starting process. ---");

      const form = e.target;
      const ref = 'REF' + Date.now();
      const referenceBox = document.getElementById('referenceNumber');
      const submitButton = form.querySelector('button[type="submit"]');

      submitButton.disabled = true;
      submitButton.innerText = 'Processing PDFs…';
      referenceBox.classList.remove('hidden');
      referenceBox.innerText = 'Finding and merging PDFs, please wait…';

      const receiptEntries = document.querySelectorAll('.receipt-entry');
      console.log(`Found ${receiptEntries.length} receipt entries in the form.`);

      if (receiptEntries.length === 0) {
        alert("Please add at least one receipt.");
        submitButton.disabled = false;
        submitButton.innerText = 'Submit';
        console.error("Submission stopped: No receipt entries found.");
        return;
      }

      const mergedPdf = await PDFDocument.create();
      let filesToMergeCount = 0;
      
      console.log("Starting to loop through entries to find and merge PDFs...");
      
      try {
        for (let i = 0; i < receiptEntries.length; i++) {
          const entry = receiptEntries[i];
          const fileInput = entry.querySelector('input[type="file"]');
          
          if (fileInput && fileInput.files.length > 0) {
            const file = fileInput.files[0];
            console.log(`Entry #${i+1}: Found file "${file.name}". Reading its contents.`);
            
            const fileBytes = await file.arrayBuffer();
            const pdf = await PDFDocument.load(fileBytes);
            console.log(`   -> Successfully loaded "${file.name}" into a PDF object.`);
            
            const copiedPages = await mergedPdf.copyPages(pdf, pdf.getPageIndices());
            copiedPages.forEach((page) => mergedPdf.addPage(page));
            console.log(`   -> Copied ${copiedPages.length} pages into the main document.`);
            
            filesToMergeCount++;
          } else {
            console.warn(`Entry #${i+1}: No file found or selected.`);
          }
        }
      } catch (error) {
          console.error("--- FATAL ERROR DURING PDF MERGING ---");
          console.error(error);
          referenceBox.innerText = '❌ A critical error occurred while merging the PDFs. Please check the console for details.';
          submitButton.disabled = false;
          submitButton.innerText = 'Submit';
          return; // Stop the function here
      }
      
      console.log(`Finished PDF processing loop. Total files merged: ${filesToMergeCount}.`);
      
      if (filesToMergeCount === 0) {
        alert("Please upload a PDF for at least one receipt entry.");
        submitButton.disabled = false;
        submitButton.innerText = 'Submit';
        console.error("Submission stopped: No files were selected for merging.");
        return;
      }
      
      console.log("Saving the merged PDF into a single file...");
      const mergedPdfBytes = await mergedPdf.save();
      const mergedPdfBase64 = uint8ArrayToBase64(mergedPdfBytes);
      console.log("Merged PDF saved and converted to Base64. Preparing to upload.");

      referenceBox.innerText = 'Uploading data…';
      const data = new URLSearchParams();
      
      const formData = new FormData(form);
      for (const [key, value] of formData.entries()) {
          if (typeof value !== 'object') {
             data.append(key, value);
          }
      }
      
      data.append("reference", ref);
      data.append("receiptCount", receiptIndex);
      
      data.append("fileBase64", mergedPdfBase64);
      data.append("fileName", `Consolidated_Receipts_${ref}.pdf`);
      data.append("fileMimeType", "application/pdf");

      console.log("Data payload is ready. Sending to Google Apps Script...");

      fetch("https://script.google.com/macros/s/AKfycbzjlYyL7MZOSicjuOv_Bk6gmsxEQ8SdQnFb0IlCdjeMjn72JRsun_y1XWtGbpdLrICeAA/exec", {
        method: "POST",
        body: data
      })
      .then(response => response.text())
      .then(result => {
        console.log("✅ Submission result from Google:", result);
        referenceBox.innerText = '✅ Request submitted successfully!\nYour reference number is: ' + ref;
        form.reset();
        document.getElementById('receipts').innerHTML = '';
        receiptIndex = 0;
      })
      .catch(error => {
        console.error("❌ Error submitting form to Google:", error);
        referenceBox.innerText = '❌ Something went wrong. Please check the console and try again.';
      })
      .finally(() => {
        submitButton.disabled = false;
        submitButton.innerText = 'Submit';
      });
    });
  </script>
</body>
</html>
