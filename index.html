<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Reimbursement Portal</title>
  <script src="https://unpkg.com/pdf-lib"></script>
  <script src="https://cdn.jsdelivr.net/npm/iban/dist/iban.min.js"></script>
  <style>
    body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; margin: 2rem; background-color: #f4f4f9; color: #333; }
    h1, h2, h3 { color: #2c3e50; }
    .hidden { display: none; }
    .form-section, .receipt-entry { margin-bottom: 1.5rem; padding: 1.5rem; border: 1px solid #ddd; border-radius: 8px; background-color: #fff; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
    label { display: block; margin-top: 1rem; font-weight: bold; color: #555; }
    input, select, textarea { width: 100%; padding: 0.75rem; margin-top: 0.3rem; border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box; }
    input:disabled { background-color: #f0f0f0; cursor: not-allowed; }
    button { background-color: #3498db; color: white; padding: 0.75rem 1.5rem; margin-top: 1rem; border: none; border-radius: 4px; cursor: pointer; font-size: 1rem; transition: background-color 0.3s; }
    .validation-message { font-size: 0.9em; margin-top: 0.3rem; }
    .invalid { color: #e74c3c; }
    .valid { color: #2ecc71; }
    #referenceNumber { margin-top: 1rem; font-weight: bold; white-space: pre-line; padding: 1rem; border-radius: 4px; text-align: center; }
    #progressContainer { width: 100%; background-color: #e0e0e0; border-radius: 4px; margin-top: 1rem; overflow: hidden; }
    #progressBar { width: 0%; height: 24px; background-color: #3498db; border-radius: 4px; text-align: center; color: white; line-height: 24px; transition: width 0.4s ease; }
  </style>
</head>
<body>
  <h1>Reimbursement Portal</h1>
  
  <div id="form">
    <h2>Submit New Reimbursement Request</h2>
    <form id="reimbursementForm">
      <div class="form-section">
        <label for="employeeStatus">Are you employed by the institute?</label>
        <select id="employeeStatus" name="employeeStatus" required onchange="handleFormDisplay()">
          <option value="" disabled selected>Please select an option</option>
          <option value="yes">Yes (Internal Reimbursement)</option>
          <option value="no">No (External Reimbursement)</option>
        </select>
      </div>

      <div id="commonInfoSection" class="form-section hidden">
        <label>Full Name</label><input type="text" name="fullName" required>
        <label>Email Address</label><input type="email" name="email" required>
        <label>Project Lead or Project Name</label><input list="projectNumbers" name="project" required>
        <datalist id="projectNumbers"><option value="Christine LUTRINGER – AHCD 2025 – P0189"><option value="Vincent CHETAIL – NCCR / Migration Governance – S2334"></datalist>
      </div>

      <div id="bankDetailsSection" class="form-section hidden">
        <h3>Bank Details</h3>
        <label>IBAN</label>
        <input type="text" name="iban" id="ibanInput" oninput="handleIBANInput()" placeholder="e.g., CH9300762011623852957">
        <div id="ibanValidation" class="validation-message"></div>

        <label>Bank Account Number (non-IBAN)</label>
        <input type="text" name="accountNumber" id="accountInput" oninput="handleAccountInput()">

        <label>BIC/SWIFT Code</label>
        <input type="text" name="bankCode" pattern="[A-Za-z]{4}[A-Za-z]{2}[A-Za-z0-9]{2}([A-Za-z0-9]{3})?" title="Must be a valid 8 or 11 character BIC/SWIFT code.">
        
        <label>Bank Name and Address</label>
        <input type="text" name="bankName" id="bankAddressInput" oninput="validateBankAddress()">
        <div id="bankAddressValidation" class="validation-message"></div>
      </div>

      <div id="receiptsSection" class="hidden">
        <h3>Receipts (Max 16)</h3>
        <div id="receipts"></div>
        <button type="button" onclick="addReceipt()">Add Receipt</button>
      </div>
      
      <div id="submitSection" class="hidden">
        <br><button type="submit">Submit</button>
        <div id="progressContainer" class="hidden"><div id="progressBar"></div></div>
        <div id="referenceNumber"></div>
      </div>
    </form>
  </div>

  <script>
    const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbzzimaL8zfTDCPUXC1mpU0og_k9WPiH9zhZgcchu87OiqO1vwpnxOl0RJz_Hxj5Q_nJ0g/exec";
    let receiptIndex = 0;
    const maxReceipts = 16;
    const { PDFDocument, rgb, StandardFonts } = PDFLib;

    function handleFormDisplay() { /* Same as before */ }
    function addReceipt() { /* Same as before */ }
    function handleExpenseTypeChange(index) { /* Same as before */ }
    function generateParticipantFields(index) { /* Same as before */ }
    function calculateMealsAverage(index) { /* Same as before */ }
    function updateProgress(percent, message) { /* Same as before */ }
    function uint8ArrayToBase64(bytes) { /* Same as before */ }

    // --- NEW VALIDATION FUNCTIONS ---
    function handleIBANInput() {
      const ibanInput = document.getElementById('ibanInput');
      const accountInput = document.getElementById('accountInput');
      const ibanValidationDiv = document.getElementById('ibanValidation');
      
      // Disable the other field if this one has input
      accountInput.disabled = !!ibanInput.value;
      
      // Validate the IBAN
      if (ibanInput.value) {
        if (IBAN.isValid(ibanInput.value)) {
          ibanValidationDiv.innerText = '✓ Valid IBAN';
          ibanValidationDiv.className = 'validation-message valid';
        } else {
          ibanValidationDiv.innerText = '✗ Invalid IBAN format. Please check again.';
          ibanValidationDiv.className = 'validation-message invalid';
        }
      } else {
        ibanValidationDiv.innerText = '';
      }
    }

    function handleAccountInput() {
      const ibanInput = document.getElementById('ibanInput');
      const accountInput = document.getElementById('accountInput');
      // Disable the other field if this one has input
      ibanInput.disabled = !!accountInput.value;
    }

    function validateBankAddress() {
      const bankAddressInput = document.getElementById('bankAddressInput');
      const bankAddressValidationDiv = document.getElementById('bankAddressValidation');
      // Check if the input contains at least one number
      if (bankAddressInput.value && !/\d/.test(bankAddressInput.value)) {
        bankAddressValidationDiv.innerText = 'Please make sure you have provided a full address, including a street number or postal code.';
        bankAddressValidationDiv.className = 'validation-message invalid';
      } else {
        bankAddressValidationDiv.innerText = '';
      }
    }

    // --- END OF NEW VALIDATION FUNCTIONS ---
    
    document.getElementById('reimbursementForm').addEventListener('submit', async function (e) {
      e.preventDefault();
      // ... Form submission logic is the same as the "fire-and-forget" version ...
    });
  </script>
</body>
</html>
