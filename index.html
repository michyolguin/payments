<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Reimbursement Portal</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 2rem; }
    .hidden { display: none; }
    .form-section { margin-bottom: 2rem; }
    label { display: block; margin-top: 1rem; }
    input, select, textarea { width: 100%; padding: 0.5rem; margin-top: 0.3rem; }
    button { padding: 0.5rem 1rem; margin-top: 1rem; }
    .receipt-entry { margin-bottom: 1rem; padding: 1rem; border: 1px solid #ccc; }
  </style>
</head>
<body>
  <h1>Reimbursement Portal</h1>

  <div id="menu">
    <button onclick="showForm()">Submit Request</button>
    <button onclick="showStatus()">Check Status</button>
  </div>

  <!-- FORM -->
  <div id="form" class="hidden">
    <h2>Submit Reimbursement Request</h2>
    <form id="reimbursementForm">
      <div class="form-section">
        <label for="fullName">Full Name</label>
        <input type="text" id="fullName" required>

        <label for="email">Email Address</label>
        <input type="email" id="email" required>

        <label for="projectNumber">Project Lead or Project Name</label>
        <input list="projectNumbers" id="projectNumber" required placeholder="Start typing or click to browse">

        <datalist id="projectNumbers">
          <option value="Christine LUTRINGER – AHCD 2025 – P0189">
          <option value="Vincent CHETAIL – NCCR / Migration Governance – S2334">
          <!-- Add other project options here -->
        </datalist>

        <label for="iban">IBAN</label>
        <input type="text" id="iban" name="iban" pattern="[A-Z]{2}[0-9]{2}[A-Z0-9]{1,30}" placeholder="e.g., CH9300762011623852957">

        <label for="accountNumber">Bank Account Number (non-IBAN)</label>
        <input type="text" id="accountNumber" placeholder="e.g., 1234567890">

        <label for="bankCode">Bank Code (e.g., Clearing, Sort, BLZ)</label>
        <input type="text" id="bankCode" placeholder="e.g., 70000">

        <label for="bankName">Bank Name</label>
        <input type="text" id="bankName">

        <label for="address">Your Address</label>
        <textarea id="address"></textarea>
      </div>

      <div id="receipts"></div>
      <button type="button" onclick="addReceipt()">Add Receipt</button>

      <button type="submit">Submit</button>
    </form>
    <div id="referenceNumber" class="hidden"></div>
  </div>

  <!-- STATUS CHECK -->
  <div id="status" class="hidden">
    <h2>Check Request Status</h2>
    <label for="statusRef">Reference Number</label>
    <input type="text" id="statusRef">
    <button onclick="checkStatus()">Check</button>
    <div id="statusResult"></div>
  </div>

  <!-- SCRIPTS -->
  <script>
    function showForm() {
      document.getElementById('form').classList.remove('hidden');
      document.getElementById('status').classList.add('hidden');
    }

    function showStatus() {
      document.getElementById('form').classList.add('hidden');
      document.getElementById('status').classList.remove('hidden');
    }

    function addReceipt() {
      const container = document.createElement('div');
      container.classList.add('receipt-entry');
      container.innerHTML = `
        <label>Upload Receipt (PDF, PNG, JPG)</label>
        <input type="file" accept=".pdf,.png,.jpg" required>
        <label>Currency</label>
        <input type="text" placeholder="e.g., CHF" required>
        <label>Amount</label>
        <input type="number" step="0.01" required>
        <label>Expense Type</label>
        <select required>
          <option value="">Select a type</option>
          <option value="Travel">Travel</option>
          <option value="Accommodation">Accommodation</option>
          <option value="Meals">Meals</option>
          <option value="Supplies">Supplies</option>
          <option value="Honorarium">Honorarium</option>
          <option value="Other">Other</option>
        </select>
      `;
      document.getElementById('receipts').appendChild(container);
    }

    document.getElementById('reimbursementForm').addEventListener('submit', function(e) {
      e.preventDefault();

      // Validate IBAN vs account+code
      const iban = document.getElementById('iban').value.trim();
      const acc = document.getElementById('accountNumber').value.trim();
      const code = document.getElementById('bankCode').value.trim();

      const hasIBAN = iban.length > 0;
      const hasCombo = acc.length > 0 && code.length > 0;

      if (!hasIBAN && !hasCombo) {
        alert('Please enter either IBAN or Account Number + Bank Code.');
        return;
      }

      const ref = 'REF' + Math.floor(Math.random() * 1_000_000);

      const data = new URLSearchParams();
      data.append("fullName", document.getElementById("fullName").value);
      data.append("email", document.getElementById("email").value);
      data.append("project", document.getElementById("projectNumber").value);
      data.append("reference", ref);

      fetch("https://script.google.com/macros/s/AKfycbwNoQD2z6wmIunlwIoMbeQ6F73htfgL5bhdeZnjjxlz42U0t8PmLA-Y2sR9c7Yew3rc2Q/exec", {
        method: "POST",
        headers: { "Content-Type": "application/x-www-form-urlencoded" },
        body: data
      })
      .then(response => response.text())
      .then(result => {
        console.log("✅ Sent to Google Sheet:", result);
        document.getElementById('referenceNumber').innerText =
          'Request submitted. Your reference number is: ' + ref;
        document.getElementById('referenceNumber').classList.remove('hidden');
        document.getElementById('reimbursementForm').reset();
        document.getElementById('receipts').innerHTML = '';
      })
      .catch(error => {
        console.error("❌ Error sending to Sheet:", error);
        alert("Something went wrong. Please try again.");
      });
    });

    function checkStatus() {
      const ref = document.getElementById('statusRef').value.trim();
      document.getElementById('statusResult').innerText =
        ref ? `Status for ${ref}: Pending Review.` : '';
    }
  </script>
</body>
</html>
