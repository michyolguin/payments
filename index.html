<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>REIMBURSEMENT PORTAL</title>

  <!-- Fonts: Montserrat with bold for titles -->
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500;600;700;800&display=swap" rel="stylesheet">

  <!-- Libs -->
  <script src="https://unpkg.com/pdf-lib"></script>
  <script src="https://cdn.jsdelivr.net/npm/iban/dist/iban.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/tesseract.js@5.0.1/dist/tesseract.min.js"></script>

  <style>
    :root{
      --brand-red:#b3002d; /* Institut ish red */
      --ink:#111;
      --muted:#6b7280;
      --line:#000;
      --bg:#fafafa;
      --card:#fff;
      --font-head:"Montserrat", system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif;
      --font-body:"Montserrat", system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif;
    }

    html,body{margin:0;padding:0;background:var(--bg);color:var(--ink);font-family:var(--font-body);}

    .container{max-width:980px;margin:40px auto;padding:0 20px;}
    h1{font-family:var(--font-head);font-weight:800;letter-spacing:.2px;margin:0 0 8px;}
    .subtitle{color:var(--muted);margin-bottom:24px;}

    /* red line CHECK FOR STICKY*/
    .section{
      background:var(--card);
      border-radius:14px;
      padding:0;
      box-shadow:0 2px 10px rgba(0,0,0,.05);
      margin-bottom:24px;
      overflow:hidden;
    }
    .section-head{
      position:sticky; top:0; z-index:2;
      background:#fff;
      padding:18px 20px 14px;
      border-bottom:3px solid var(--brand-red);
    }
    .section-head h2{
      margin:0;
      font:800 20px/1 var(--font-head);
      letter-spacing:.2px;
    }
    .section-body{padding:20px;}

    /*Red line and titles section*/
    .section-head { 
      border-bottom: none !important;              /* hide the rest of the borders*/
    }

    .section-head h2{
      position: relative;
      padding-left: 100px;                          /* space between title and red line */
    }

    .section-head h2::before{
      content: "";
      position: absolute;
      left: 20px;                                  /* padding for title section */
      top: 50%;
      transform: translateY(-50%);
      width: 64px;                                 /* length dash */
      height: 4px;
      background: var(--brand-red, #B6002A);       /* Institute red CHECK*/
      border-radius: 999px;
      display: block;
    }
    /*-ENd of red line and title sections*/    

    /* lines, for boxes section */
    .row{display:grid;grid-template-columns:1fr;gap:20px;} /* spaces between fields*/
    /* extra space between consecutive rows */
    .section-body .row + .row { margin-top: 10px; }
    @media (min-width:720px){ .row.two{grid-template-columns:1fr 1fr;} .row.three{grid-template-columns:1fr 1fr 1fr;} }

    .field{position:relative;}
    .field input,
    .field select,
    .field textarea{
      width:100%;
      border:none;
      border-bottom:1px solid var(--line);
      background:transparent;
      padding:12px 8px 10px 0;
      font:500 15px/1.35 var(--font-body);
      outline:none;
      transition:border-color .2s ease, color .2s ease, opacity .2s ease;
    }
    input:focus, select:focus, textarea:focus {
      outline: none;
      border-bottom: 3px solid #b6002a; /* bold red underline */
    }
    .field select{padding-right:28px; -webkit-appearance:none; appearance:none; background-image:linear-gradient(45deg,transparent 50%, var(--ink) 50%),linear-gradient(135deg, var(--ink) 50%, transparent 50%); background-position:calc(100% - 16px) calc(1.05em), calc(100% - 11px) calc(1.05em); background-size:5px 5px, 5px 5px; background-repeat:no-repeat; }
    .field input::placeholder,
    .field textarea::placeholder{color:var(--muted);}
    .field small{display:block;margin-top:6px;color:var(--muted);}

    .field.disabled input,
    .field.disabled textarea,
    .field.disabled select{
      opacity:.5;
      pointer-events:none;
    }

    .field .help{font-size:.85rem;color:var(--muted);margin-top:6px;min-height:1em;}

    .hidden{display:none !important;}

    /* Buttons */
    .btn{
      display:inline-flex;align-items:center;gap:.5rem;
      border:none;background:#000;color:#fff;
      padding:12px 16px;border-radius:10px;
      font-weight:600;cursor:pointer;
      transition:transform .04s ease, opacity .2s ease, background .2s ease;
    }
    .btn.secondary{background:#e7e7e7;color:#000;}
    .btn:active{transform:translateY(1px);}

    /* Receipt card */
    .receipt{padding:16px;border-top:1px dashed #ddd;}
    .receipt h4{margin:0 0 8px;font-weight:700;}
    .badge{display:inline-block;font-size:.8rem;padding:2px 8px;border:1px solid #ddd;border-radius:99px;color:#555;margin-left:8px;}

    /* Acknowledgement note */
    .ack{
      background:#fff5d5;border:1px solid #ffe08a;border-radius:10px;
      padding:10px 12px;margin-top:8px;font-size:.9rem;
    }

    /* progress */
    #progressContainer{width:100%;background:#eaeaea;border-radius:8px;overflow:hidden;height:10px;margin-top:10px;}
    #progressBar{height:10px;background:var(--brand-red);width:0%;transition:width .35s ease;}

    /* links in messages */
    a{color:var(--brand-red);text-decoration:none;}
    a:hover{text-decoration:underline;}

    /*hiding fields style*/

    .collapsed { display: none !important; }
    .dim { opacity: 0.5; }

    /* Drag & drop area */
    .dropzone{
      border:2px dashed #d1d5db;
      border-radius:14px;
      background:#fff;
      padding:24px;
      margin-top:16px;
      text-align:center;
      cursor:pointer;
      transition:border-color .2s ease, background-color .2s ease, box-shadow .2s ease;
    }
    .dropzone:hover{ border-color:#c4c7cf; }
    .dropzone.dragover{
      border-color: var(--brand-red);
      background:#fff6f8;
      box-shadow:0 0 0 3px rgba(182,0,42,.06) inset;
    }
    .dz-inner{
      display:flex; align-items:center; justify-content:center; gap:12px; pointer-events:none;
    }
    .dz-plus{
      width:34px; height:34px; line-height:34px; border-radius:50%;
      border:2px solid var(--brand-red);
      color:var(--brand-red);
      font-weight:800; font-size:20px;
    }
    .dz-text{ font-weight:600; color:#444; }
    .dz-sub{ color:var(--muted); font-weight:500; }
    .file-chip{
      display:inline-flex; align-items:center; gap:8px;
      padding:6px 10px; border:1px solid #e5e7eb; border-radius:999px;
      background:#f9fafb; font-size:.9rem; margin-top:6px;
    }
    .file-chip button{
      border:none; background:transparent; cursor:pointer; color:var(--brand-red);
      font-weight:600; padding:0;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>Reimbursement Portal</h1>
    <div class="subtitle">Now accounting-proof.</div>

    <form id="reimbursementForm" autocomplete="on">
      <!-- Section: Basics -->
      <section class="section">
        <div class="section-head"><h2>Basics</h2></div>
        <div class="section-body">
          <div class="row">
            <div class="field">
              <select id="employeeStatus" name="employeeStatus" required>
                <option value="" disabled selected>Are you employed by the Institute? (Internal vs External)</option>
                <option value="yes">Yes (Internal Reimbursement)</option>
                <option value="no">No (External Reimbursement)</option>
              </select>
            </div>
          </div>

          <div class="row two">
            <div class="field">
              <input type="text" name="fullName" placeholder="Full name" autocomplete="name" required>
            </div>
            <div class="field">
              <input type="email" name="email" placeholder="Email address" autocomplete="email" required>
            </div>
          </div>

          <div class="row">
            <div class="field">
              <input list="projectNumbers" name="project" id="projectInput" placeholder="Project lead or project name (start typing to find)" required autocomplete="organization">
              <datalist id="projectNumbers">
                <option value="Christine LUTRINGER – AHCD 2025 – P0189">
                <option value="Doc.CH / Health as a Form of Politics in North India – P0024">
                <option value="Vincent CHETAIL – NCCR / Migration Governance – S2334">
              </datalist>
            </div>
          </div>

          <div class="row">
            <div class="field">
              <textarea name="reimbursementReason" rows="1" placeholder="Reason for reimbursement" required></textarea>
            </div>
          </div>

          <div class="row">
            <div class="field">
              <textarea name="address" rows="2" placeholder="Your address (Number, Street, City, Zip Code) ("></textarea>
            </div>
          </div>
        </div>
      </section>

      <!-- Section: Bank (External only) -->
      <section id="bankDetailsSection" class="section hidden">
        <div class="section-head"><h2>Bank details (External)</h2></div>
        <div class="section-body">

          <div class="row two">
            <div class="field" id="ibanField">
              <input type="text" name="iban" id="ibanInput" inputmode="text" autocapitalize="characters"
                     placeholder="IBAN (e.g., CH9300762011623852957)">
              <div id="ibanValidation" class="help"></div>
            </div>

            <div class="field" id="acctField">
              <input type="text" name="accountNumber" id="accountInput" inputmode="numeric"
                     placeholder="Bank account number (non-IBAN)">
              <div id="acctValidation" class="help"></div>
            </div>
          </div>

          <div id="bicGroup" class="row hidden">
            <div class="field" id="bicField">
              <input type="text" name="bankCode" id="bankCodeInput"
                     pattern="[A-Za-z]{4}[A-Za-z]{2}[A-Za-z0-9]{2}([A-Za-z0-9]{3})?"
                     title="Valid BIC/SWIFT is 8 or 11 characters."
                     placeholder="BIC/SWIFT (e.g., UBSWCHZH80A)">
              <div id="bicHint" class="help"></div>
            </div>
          </div>

          <div class="row">
            <div class="field">
              <input type="text" name="bankName" id="bankAddressInput"
                     autocomplete="organization"
                     pattern=".*\\d.*"
                     title="Please include a street/number (e.g., 'Bank, Street 10, City')."
                     placeholder="Bank name and address (must include a street number)">
              <div id="bankAddressValidation" class="help"></div>
            </div>
          </div>
        </div>
      </section>

      <!-- Section: Receipts -->
      <section class="section">
        <div class="section-head"><h2>Receipts</h2></div>
        <div class="section-body">
        <div id="receipts"></div>

      <!-- Drag drop to add receipts to be added here-->
        <!-- Add receipt button -->
        <div style="margin-top:12px;">
          <button type="button" id="addReceiptBtn" class="btn btn-red-plus">+ Add receipt</button>
        </div>

          <!-- Travel declaration (auto-shown if any receipt = Travel) -->
          <div id="travelSection" class="hidden" style="margin-top:20px;">
            <div class="row">
              <div class="field"><small>Travel declaration (only when you had travel expenses)</small></div>
            </div>
            <div class="row">
              <div class="field">
                <label style="display:block; margin:8px 0 0;">
                  <input type="radio" name="planeReason" value="Train" checked> I took the train
                </label>
                <label style="display:block; margin:8px 0 0;">
                  <input type="radio" name="planeReason" value="Train>7h"> I took a plane as the travel by train takes more than 7h
                </label>
                <label style="display:block; margin:8px 0 0;">
                  <input type="radio" name="planeReason" value="Exception"> I took a plane because of the following exception:
                </label>
                <div id="travelExceptionBox" class="hidden" style="margin-top:.5rem">
                  <select name="planeException">
                    <option value="">Select an exception…</option>
                    <option>Health impairments of the person travelling</option>
                    <option>Reconciling care responsibilities and work</option>
                    <option>Safety considerations due to particular events</option>
                    <option>Teaching and/or administrative constraints</option>
                    <option>Cases of force majeure</option>
                    <option>For PhD students only: significant price differences</option>
                  </select>
                </div>
              </div>
            </div>
          </div>

          <div style="margin-top:18px;">
            <label style="display:inline-flex;align-items:center;gap:.5rem;">
              <input type="checkbox" id="rememberMe"> <span>Remember my name, email, and address on this device</span>
            </label>
          </div>
        </div>
      </section>

      <!-- Submit -->
      <div style="display:flex;gap:10px;align-items:center;">
        <button type="submit" class="btn">Submit</button>
        <div id="progressContainer" class="hidden" style="flex:1;">
          <div id="progressBar"></div>
        </div>
      </div>
      <div id="referenceNumber" style="margin-top:12px;font-weight:700;"></div>
    </form>
  </div>

  <script>
    // Use your current deployment:
    const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbxwFC0HZsJWbPijNsnHPK6h-uD3A1kLAS3WXveoQTJSH3UiW3K1Cltbu5wdPqvRRBSFiQ/exec";

    let receiptIndex = 0;
    const maxReceipts = 16;
    const { PDFDocument, rgb, StandardFonts } = PDFLib;

    // -----------------------------
    // Project → expense & task map
    // -----------------------------
    const PROJECTS = {
      "P0189": {
        label: "Christine LUTRINGER – AHCD 2025 – P0189",
        expenseTypes: ["Travel", "Accommodation", "Meals", "Supplies", "Honorarium", "Other"],
        taskByType: {}
      },
      "P0024": {
        label: "Doc.CH / Health as a Form of Politics in North India – P0024",
        expenseTypes: ["Travel", "Accommodation", "Meals", "Supplies", "Other"],
        taskByType: { "Travel":"30","Accommodation":"31","Meals":"32","Supplies":"33","Other":"39" }
      },
      "S2334": {
        label: "Vincent CHETAIL – NCCR / Migration Governance – S2334",
        expenseTypes: ["Travel", "Accommodation", "Meals", "Supplies", "Honorarium", "Other"],
        taskByType: { "Travel":"10","Accommodation":"11","Meals":"12","Supplies":"13","Honorarium":"14","Other":"19" }
      }
    };

    function detectProjectCode(inputValue) {
      const m = (inputValue || "").toUpperCase().match(/\b([PS]\d{4})\b/);
      return m ? m[1] : null;
    }
    function getProjectProfile() {
      const raw = document.getElementById('projectInput').value.trim();
      const code = detectProjectCode(raw);
      return code && PROJECTS[code] ? { code, ...PROJECTS[code] } : null;
    }

    // -----------------------------
    // Remember fields
    // -----------------------------
    document.addEventListener('DOMContentLoaded', () => {
      try {
        const saved = JSON.parse(localStorage.getItem('reimb_user_defaults') || '{}');
        if (saved.fullName) document.querySelector('input[name="fullName"]').value = saved.fullName;
        if (saved.email) document.querySelector('input[name="email"]').value = saved.email;
        if (saved.address) document.querySelector('textarea[name="address"]').value = saved.address;
      } catch {}
      initBankBlock();
    });

    function saveDefaultsIfWanted() {
      const remember = document.getElementById('rememberMe')?.checked;
      if (!remember) return;
      const payload = {
        fullName: document.querySelector('input[name="fullName"]').value || '',
        email: document.querySelector('input[name="email"]').value || '',
        address: document.querySelector('textarea[name="address"]').value || ''
      };
      localStorage.setItem('reimb_user_defaults', JSON.stringify(payload));
    }

    // -----------------------------
    // Show/Hide sections
    // -----------------------------
    document.getElementById('employeeStatus').addEventListener('change', handleFormDisplay);
    function handleFormDisplay() {
      const status = document.getElementById('employeeStatus').value;
      const bankSection = document.getElementById('bankDetailsSection');
      if (status === 'no') bankSection.classList.remove('hidden');
      else bankSection.classList.add('hidden');
    }

    // Project change → update expense options + task defaults
    document.getElementById('projectInput').addEventListener('input', refreshExpenseTypeOptionsForAllReceipts);
    document.getElementById('projectInput').addEventListener('change', refreshExpenseTypeOptionsForAllReceipts);
    function refreshExpenseTypeOptionsForAllReceipts() {
      const profile = getProjectProfile();
      const entries = document.querySelectorAll('.receipt-entry');
      entries.forEach((entry, idx) => {
        const select = entry.querySelector(`select[name="type${idx}"]`);
        if (!select) return;
        const current = select.value;
        const list = (profile && profile.expenseTypes?.length) ? profile.expenseTypes
                    : ["Travel", "Accommodation", "Meals", "Supplies", "Honorarium", "Other"];
        select.innerHTML = `<option value="">Expense type…</option>` + list.map(t => `<option value="${t}">${t}</option>`).join('');
        if (current && list.includes(current)) select.value = current;
        assignTaskNumberForEntry(idx);
      });
    }

    // -----------------------------
    // Add receipt block
    // -----------------------------
    function addReceipt() {
      if (receiptIndex >= maxReceipts) { alert(`Maximum of ${maxReceipts} receipts allowed.`); return; }
      const i = receiptIndex++;

      const profile = getProjectProfile();
      const expenseList = (profile && profile.expenseTypes?.length)
        ? profile.expenseTypes
        : ["Travel", "Accommodation", "Meals", "Supplies", "Honorarium", "Other"];

      const container = document.createElement('div');
      container.className = 'receipt receipt-entry';
      container.id = `receipt-entry-${i}`;
      container.innerHTML = `
        <h4>Receipt ${i+1} <span class="badge">Max 16</span></h4>

        <div class="row two">
          <div class="field">
            <input type="file" name="receiptFile${i}" id="receiptFile${i}" accept=".pdf,.jpg,.jpeg,.png" required>
            <div id="fileChip${i}" class="file-chip hidden"></div>
            <small>Upload receipt (PDF, JPG, PNG)</small>
          </div>
          <div class="field">
            <input type="date" name="date${i}" required>
            <small>Date</small>
          </div>
        </div>

        <div class="row two">
          <div class="field">
            <select name="type${i}" required>
              <option value="">Expense type…</option>
              ${expenseList.map(t => `<option value="${t}">${t}</option>`).join('')}
            </select>
          </div>
          <input type="hidden" name="taskNumber${i}">
        </div>

        <div id="meal-participants-${i}" class="hidden">
          <div class="row">
            <div class="field">
              <input type="number" name="participants_count${i}" min="1" placeholder="Number of participants">
            </div>
          </div>
          <div class="row" id="participant-names-${i}"></div>
        </div>

        <div class="row two">
          <div class="field">
            <input type="text" name="currency${i}" placeholder="Currency (e.g., CHF)" autocomplete="off" required>
          </div>
          <div class="field">
            <input type="number" name="amount${i}" inputmode="decimal" step="0.01" placeholder="Amount" required>
          </div>
        </div>

        <div class="row">
          <button type="button" class="btn secondary" onclick="scanReceipt(${i})">Scan for total</button>
          <div id="scan-msg-${i}" class="help" style="margin-left:10px;"></div>
        </div>

        <div id="pp-message-${i}" class="help"></div>
        <div id="ack-box-${i}" class="ack hidden">
          <label style="display:flex;gap:.5rem;align-items:flex-start;">
            <input type="checkbox" id="ack-checkbox-${i}" name="ack_limit_${i}">
            <span>I acknowledge that the reimbursement for this meal will be capped at the Graduate Institute's maximum per-person rate.</span>
          </label>
        </div>
      `;
      document.getElementById('receipts').appendChild(container);

      // wire up listeners
      const typeSel = container.querySelector(`select[name="type${i}"]`);
      const amountInput = container.querySelector(`input[name="amount${i}"]`);
      const participantsCount = container.querySelector(`input[name="participants_count${i}"]`);

      typeSel.addEventListener('change', () => handleExpenseTypeChange(i));
      if (participantsCount) participantsCount.addEventListener('input', () => generateParticipantFields(i));
      if (amountInput) amountInput.addEventListener('input', () => calculateMealsAverage(i));

      assignTaskNumberForEntry(i);
      toggleTravelSection();
      decorateReceiptFileInput(i);
    }

    function assignTaskNumberForEntry(index) {
      const profile = getProjectProfile();
      const entry = document.getElementById(`receipt-entry-${index}`);
      if (!entry) return;
      const typeSel = entry.querySelector(`select[name="type${index}"]`);
      const taskInput = entry.querySelector(`input[name="taskNumber${index}"]`);
      if (!typeSel || !taskInput) return;

      const selectedType = typeSel.value || "";
      const defaultTask = (profile && profile.taskByType && profile.taskByType[selectedType]) ? profile.taskByType[selectedType] : "";
      taskInput.value = defaultTask;
    }

    function handleExpenseTypeChange(index) {
      calculateMealsAverage(index);
      toggleTravelSection();
      assignTaskNumberForEntry(index);

      const expenseType = document.querySelector(`select[name="type${index}"]`).value;
      const mealWrap = document.getElementById(`meal-participants-${index}`);
      if (expenseType === 'Meals') {
        mealWrap.classList.remove('hidden');
      } else {
        mealWrap.classList.add('hidden');
        document.getElementById(`participant-names-${index}`).innerHTML = '';
        const count = document.querySelector(`input[name="participants_count${index}"]`);
        if (count) count.value = '';
      }
    }

    function generateParticipantFields(index) {
      const count = parseInt(document.querySelector(`input[name="participants_count${index}"]`).value || '0', 10);
      const namesContainer = document.getElementById(`participant-names-${index}`);
      namesContainer.innerHTML = '';
      if (count > 0) {
        const cols = document.createElement('div');
        cols.className = 'row two';
        for (let i = 0; i < count; i++) {
          const cell = document.createElement('div');
          cell.className = 'field';
          cell.innerHTML = `<input type="text" name="participant_${index}_name_${i}" placeholder="Participant ${i+1}" required>`;
          cols.appendChild(cell);
        }
        namesContainer.appendChild(cols);
      }
      calculateMealsAverage(index);
    }

    function calculateMealsAverage(index) {
      const msg = document.getElementById(`pp-message-${index}`);
      const ackBox = document.getElementById(`ack-box-${index}`);
      const ackCheckbox = document.getElementById(`ack-checkbox-${index}`);
      const expenseType = document.querySelector(`select[name="type${index}"]`).value;

      if (expenseType !== 'Meals') {
        msg.textContent = '';
        ackBox.classList.add('hidden');
        if (ackCheckbox) ackCheckbox.required = false;
        return;
      }

      const amountInput = document.querySelector(`input[name="amount${index}"]`);
      const participantsInput = document.querySelector(`input[name="participants_count${index}"]`);
      if (!amountInput || !participantsInput) { ackBox.classList.add('hidden'); if (ackCheckbox) ackCheckbox.required = false; return; }

      const amount = parseFloat(amountInput.value || '0');
      const participants = parseInt(participantsInput.value || '0', 10);

      if (amount > 0 && participants > 0) {
        const average = amount / participants;
        msg.textContent = `Per-person average: ${average.toFixed(2)}`;
        if (average > 60) {
          msg.textContent += ' (exceeds the institutional limit)';
          ackBox.classList.remove('hidden');
          if (ackCheckbox) ackCheckbox.required = true;
        } else {
          ackBox.classList.add('hidden');
          if (ackCheckbox) ackCheckbox.required = false;
        }
      } else {
        msg.textContent = '';
        ackBox.classList.add('hidden');
        if (ackCheckbox) ackCheckbox.required = false;
      }
    }

    function toggleTravelSection() {
      const entries = Array.from(document.querySelectorAll('.receipt-entry'));
      const anyTravel = entries.some((entry, idx) => {
        const sel = entry.querySelector(`select[name="type${idx}"]`);
        return sel && sel.value === 'Travel';
      });

      const travel = document.getElementById('travelSection');
      const radios = document.querySelectorAll('input[name="planeReason"]');
      const exceptionBox = document.getElementById('travelExceptionBox');

      if (anyTravel) {
        travel.classList.remove('hidden');
        const selected = Array.from(radios).find(r => r.checked)?.value || 'Train';
        exceptionBox.classList.toggle('hidden', selected !== 'Exception');
      } else {
        travel.classList.add('hidden');
      }
    }

    document.addEventListener('change', (e) => {
      if (e.target && e.target.name === 'planeReason') {
        document.getElementById('travelExceptionBox')
          .classList.toggle('hidden', e.target.value !== 'Exception');
      }
    });

  // --------- Bank UI (peek on focus, hide on blur if empty, lock once typing) ----------
let ibanEl, ibanMsg, acctEl, acctMsg, bicGroupEl, bicEl, bicHintEl, bankAddrEl, bankAddrMsgEl;
const ibanPH = 'IBAN (e.g., CH9300762011623852957)';
const acctPH = 'Bank account number (non-IBAN)';

// wrappers we’ll manipulate
let ibanFieldWrap, acctFieldWrap;

// lock mode once user starts typing: null | 'iban' | 'acct'
let bankActiveMode = null;

function initBankBlock() {
  ibanEl         = document.getElementById('ibanInput');
  ibanMsg        = document.getElementById('ibanValidation');
  acctEl         = document.getElementById('accountInput');
  acctMsg        = document.getElementById('acctValidation');
  bicGroupEl     = document.getElementById('bicGroup');
  bicEl          = document.getElementById('bankCodeInput');
  bicHintEl      = document.getElementById('bicHint');
  bankAddrEl     = document.getElementById('bankAddressInput');
  bankAddrMsgEl  = document.getElementById('bankAddressValidation');

  // wrappers (these are your two-up grid children)
  ibanFieldWrap  = document.getElementById('ibanField');
  acctFieldWrap  = document.getElementById('acctField');

  // IBAN focus → “peek” (temporarily hide the other if both are empty)
  if (ibanEl) {
    ibanEl.addEventListener('focus', () => {
      if (!bankActiveMode && !ibanEl.value && !acctEl.value) {
        acctFieldWrap.classList.add('collapsed');   // peek-hide account
      }
    });
    // blur → if nothing typed, bring it back
    ibanEl.addEventListener('blur', () => {
      if (!bankActiveMode && !ibanEl.value) {
        acctFieldWrap.classList.remove('collapsed');
      }
    });
    // input → lock to IBAN until cleared
    ibanEl.addEventListener('input', () => {
      ibanEl.value = (ibanEl.value || '').toUpperCase().replace(/\s+/g,'');
      if (ibanEl.value) {
        bankActiveMode = 'iban';
        lockToIBAN();
      } else {
        // if cleared and account blank, unlock
        if (!acctEl.value) {
          bankActiveMode = null;
          unlockBoth();
        }
      }
      updateBankValidationAndBIC();
    });
  }

  // Account focus/blur/input do the symmetric thing
  if (acctEl) {
    acctEl.addEventListener('focus', () => {
      if (!bankActiveMode && !ibanEl.value && !acctEl.value) {
        ibanFieldWrap.classList.add('collapsed');   // peek-hide IBAN
      }
    });
    acctEl.addEventListener('blur', () => {
      if (!bankActiveMode && !acctEl.value) {
        ibanFieldWrap.classList.remove('collapsed');
      }
    });
    acctEl.addEventListener('input', () => {
      if (acctEl.value) {
        bankActiveMode = 'acct';
        lockToAccount();
      } else {
        if (!ibanEl.value) {
          bankActiveMode = null;
          unlockBoth();
        }
      }
      updateBankValidationAndBIC();
    });
  }

  // Normalize BIC typed value
  if (bicEl) {
    bicEl.addEventListener('input', () => {
      bicEl.value = (bicEl.value || '').toUpperCase().replace(/\s+/g,'');
    });
  }

  // first paint
  updateBankValidationAndBIC();
}

/* Helpers to set disabled/placeholder look */
function setFieldDisabled(wrapper, inputEl, disabled, placeholderText){
  wrapper.classList.toggle('disabled', !!disabled);  // greys + blocks
  inputEl.disabled = !!disabled;
  if (disabled) {
    inputEl.dataset.savedPlaceholder = inputEl.dataset.savedPlaceholder || placeholderText || inputEl.placeholder || '';
    inputEl.placeholder = '';
  } else {
    inputEl.placeholder = inputEl.dataset.savedPlaceholder || placeholderText || '';
  }
}

/* Lock/unlock states */
function lockToIBAN(){
  // account disappears + disables; IBAN enabled
  acctFieldWrap.classList.add('collapsed');
  setFieldDisabled(acctFieldWrap, acctEl, true, acctPH);
  setFieldDisabled(ibanFieldWrap, ibanEl, false, ibanPH);
  ibanFieldWrap.classList.remove('collapsed');
}
function lockToAccount(){
  ibanFieldWrap.classList.add('collapsed');
  setFieldDisabled(ibanFieldWrap, ibanEl, true, ibanPH);
  setFieldDisabled(acctFieldWrap, acctEl, false, acctPH);
  acctFieldWrap.classList.remove('collapsed');
}
function unlockBoth(){
  ibanFieldWrap.classList.remove('collapsed');
  acctFieldWrap.classList.remove('collapsed');
  setFieldDisabled(ibanFieldWrap, ibanEl, false, ibanPH);
  setFieldDisabled(acctFieldWrap, acctEl, false, acctPH);
}

/* Validation + BIC “unfurl” (non-CH IBAN or any Account #) */
function updateBankValidationAndBIC() {
  if (!ibanEl || !acctEl) return;

  const iban = (ibanEl.value || '').toUpperCase();
  const acct = (acctEl.value || '').trim();
  const usingIBAN = !!iban;
  const usingAcct = !!acct;
  const isSwissIBAN = usingIBAN && iban.startsWith('CH');
  const needBIC = (usingIBAN && !isSwissIBAN) || usingAcct;

  // messages
  if (usingIBAN) {
    try {
      ibanMsg.textContent = IBAN.isValid(iban) ? '' : 'IBAN format may be invalid.';
    } catch { ibanMsg.textContent = ''; }
  } else { ibanMsg.textContent = ''; }

  if (usingAcct) {
    const ok = /^[0-9A-Za-z \-]{4,30}$/.test(acct);
    acctMsg.textContent = ok ? '' : 'Use 4–30 digits/letters (spaces and - allowed).';
  } else { acctMsg.textContent = ''; }

  // BIC visibility + requirement
  bicGroupEl.classList.toggle('hidden', !needBIC);
  if (bicEl) bicEl.required = !!needBIC;
  bicHintEl.textContent = needBIC
    ? 'BIC/SWIFT is required for non-Swiss IBANs or when using a bank account number.'
    : '';
}
// --------- end Bank UI ----------

    // ---------------------
    // OCR: Scan for totals
    // ---------------------
    async function scanReceipt(index) {
      const msg = document.getElementById(`scan-msg-${index}`);
      msg.textContent = '';

      const entry = document.getElementById(`receipt-entry-${index}`);
      const fileInput = entry?.querySelector(`input[name="receiptFile${index}"]`);
      if (!fileInput || fileInput.files.length === 0) { msg.textContent = 'Please choose a receipt file first.'; return; }
      const file = fileInput.files[0];

      if (file.type === 'application/pdf' || file.name.toLowerCase().endsWith('.pdf')) { msg.textContent = 'For scanning, please upload a JPG/PNG (PDF scan coming soon).'; return; }
      if (!file.type.startsWith('image/')) { msg.textContent = 'Unsupported file type. Please upload a JPG or PNG.'; return; }

      const scanButton = entry.querySelector('button[onclick^="scanReceipt("]');
      const prevLabel = scanButton.textContent;
      scanButton.disabled = true;
      scanButton.textContent = 'Scanning…';
      msg.textContent = '';

      try {
        const dataUrl = await new Promise((resolve, reject) => {
          const reader = new FileReader();
          reader.onload = () => resolve(reader.result);
          reader.onerror = reject;
          reader.readAsDataURL(file);
        });

        const { createWorker } = Tesseract;
        const worker = await createWorker('eng', 1, {
          logger: m => {
            if (m.status === 'recognizing text' && m.progress != null) {
              msg.textContent = `Scanning… ${Math.round(m.progress * 100)}%`;
            }
          }
        });

        const result = await worker.recognize(dataUrl);
        await worker.terminate();

        const text = (result && result.data && result.data.text) ? result.data.text : '';
        if (!text.trim()) { msg.textContent = 'No text detected. Try a clearer photo.'; return; }

        const { currencyGuess, amountGuess, debugNote } = extractTotalFromText(text);
        const currencyInput = entry.querySelector(`input[name="currency${index}"]`);
        const amountInput = entry.querySelector(`input[name="amount${index}"]`);

        if (currencyGuess) currencyInput.value = currencyGuess;
        if (amountGuess != null) amountInput.value = amountGuess.toFixed(2);

        if (amountGuess == null) {
          msg.textContent = 'Couldn’t confidently find a total. Please enter it manually.';
        } else {
          msg.textContent = `Suggested total: ${currencyInput.value || ''} ${amountGuess.toFixed(2)}${debugNote ? ' • ' + debugNote : ''}`;
          calculateMealsAverage(index);
        }
      } catch (err) {
        console.error('OCR error:', err);
        msg.textContent = 'Scan failed. Try a clearer image.';
      } finally {
        scanButton.disabled = false;
        scanButton.textContent = prevLabel;
      }
    }

    function extractTotalFromText(text) {
      const t = text.replace(/\u00A0/g, ' ').replace(/[,，]/g, '.');
      const currencyTokens = ['CHF', 'SFR', 'FR', 'EUR', '€', 'USD', '\\$','GBP','£'];
      const totalHints = /(grand\s*total|amount\s*due|total\s*to\s*pay|total|balance\s*due)/i;
      const lines = t.split(/\r?\n/).map(l => l.trim()).filter(Boolean);

      let bestCurrency = null, bestAmount = null;
      const moneyOnLine = (line) => {
        const moneyRegex = new RegExp(`(?:(${currencyTokens.join('|')})\\s*)?(\\d{1,3}(?:\\.\\d{3})*(?:\\.\\d{2})|\\d+\\.\\d{2})(?:\\s*(${currencyTokens.join('|')}))?`, 'i');
        const m = line.match(moneyRegex);
        if (!m) return null;
        const leftCur = m[1], numStr = m[2], rightCur = m[3];
        const cur = (leftCur || rightCur || '').toUpperCase().replace(/[^A-Z€$£]/g,'');
        const amt = parseFloat(numStr);
        return { cur, amt };
      };

      for (const line of lines) {
        if (totalHints.test(line)) {
          const found = moneyOnLine(line);
          if (found) {
            bestCurrency = normalizeCurrency(found.cur) || bestCurrency;
            bestAmount = found.amt;
            return { currencyGuess: bestCurrency || guessCurrencyFromText(t) || 'CHF', amountGuess: bestAmount, debugNote: 'from “total” line' };
          }
        }
      }
      let maxFound = { amt: -1, cur: null };
      for (const line of lines) {
        const found = moneyOnLine(line);
        if (found && found.amt > maxFound.amt) maxFound = found;
      }
      if (maxFound.amt > 0) {
        bestCurrency = normalizeCurrency(maxFound.cur) || guessCurrencyFromText(t) || 'CHF';
        bestAmount = maxFound.amt;
        return { currencyGuess: bestCurrency, amountGuess: bestAmount, debugNote: 'largest amount found' };
      }
      return { currencyGuess: guessCurrencyFromText(t) || null, amountGuess: null, debugNote: null };
    }

    function normalizeCurrency(cur) {
      if (!cur) return null;
      const c = cur.toUpperCase();
      if (c.includes('CHF') || c.includes('SFR') || c === 'FR') return 'CHF';
      if (c.includes('EUR') || c.includes('€')) return 'EUR';
      if (c.includes('USD') || c.includes('$')) return 'USD';
      if (c.includes('GBP') || c.includes('£')) return 'GBP';
      return null;
    }
    function guessCurrencyFromText(text) {
      const u = text.toUpperCase();
      if (u.includes('CHF') || u.includes('SFR')) return 'CHF';
      if (u.includes('EUR') || u.includes('€')) return 'EUR';
      if (u.includes('USD') || u.includes('$')) return 'USD';
      if (u.includes('GBP') || u.includes('£')) return 'GBP';
      return null;
    }

    // -----------------------------
    // Submit
    // -----------------------------
    document.getElementById('reimbursementForm').addEventListener('submit', async function (e) {
      e.preventDefault();
      const form = e.target;
      const ref = 'REF' + Date.now();
      const referenceBox = document.getElementById('referenceNumber');
      const progressContainer = document.getElementById('progressContainer');
      const submitButton = form.querySelector('button[type="submit"]');
      submitButton.disabled = true;
      progressContainer.classList.remove('hidden');
      updateProgress(0, 'Starting...');

      // External-only banking guardrails
      const isExternal = (document.getElementById('employeeStatus').value === 'no');
      if (isExternal) {
        const iban = (document.getElementById('ibanInput').value || '').toUpperCase().replace(/\s+/g,'');
        const acct = (document.getElementById('accountInput').value || '').trim();
        const bic  = (document.getElementById('bankCodeInput')?.value || '').toUpperCase().replace(/\s+/g,'');
        const bankAddr = (document.getElementById('bankAddressInput').value || '').trim();

        const usingIBAN = iban.length > 0;
        const usingAcct = acct.length > 0;
        const isSwissIBAN = usingIBAN && iban.startsWith('CH');
        const needBIC = (usingIBAN && !isSwissIBAN) || usingAcct;

        if (!usingIBAN && !usingAcct) { alert('Please provide either an IBAN or a Bank Account Number.'); resetSubmit(); return; }
        if (usingIBAN && !IBAN.isValid(iban)) { alert('The IBAN format looks invalid.'); resetSubmit(); return; }
        if (usingAcct && !/^[0-9A-Za-z \-]{4,30}$/.test(acct)) { alert('Bank Account Number must be 4–30 characters (digits/letters, spaces and - allowed).'); resetSubmit(); return; }
        if (needBIC && !/^[A-Za-z]{4}[A-Za-z]{2}[A-Za-z0-9]{2}([A-Za-z0-9]{3})?$/.test(bic)) { alert('BIC/SWIFT is required (8 or 11 characters) for non-Swiss IBANs or when using a Bank Account Number.'); resetSubmit(); return; }
        if (!/.*\d.*/.test(bankAddr)) { alert('Please include a street number in the Bank name/address.'); resetSubmit(); return; }
      }

      function resetSubmit(){
        submitButton.disabled = false;
        progressContainer.classList.add('hidden');
      }

      try {
        updateProgress(10, 'Preparing attachments…');
        const mergedPdf = await PDFDocument.create();
        await mergedPdf.embedFont(StandardFonts.Helvetica);

        // participant page (if any Meals)
        let hasMealExpenses = false;
        const allParticipants = [];
        const receiptEntries = document.querySelectorAll('.receipt-entry');
        receiptEntries.forEach((entry, index) => {
          const expenseType = entry.querySelector(`select[name="type${index}"]`).value;
          if (expenseType === 'Meals') {
            hasMealExpenses = true;
            const count = parseInt(entry.querySelector(`input[name="participants_count${index}"]`)?.value || '0', 10);
            for (let i = 0; i < count; i++) {
              const nameInput = entry.querySelector(`input[name="participant_${index}_name_${i}"]`);
              if (nameInput && nameInput.value) allParticipants.push(nameInput.value);
            }
          }
        });

        if (hasMealExpenses && allParticipants.length){
          let page = mergedPdf.addPage();
          const { height } = page.getSize();
          let y = height - 70;
          page.drawText('Meal Participants', { x: 50, y, size: 24 });
          y -= 40;
          for (const name of allParticipants) {
            if (y < 50) { page = mergedPdf.addPage(); y = height - 70; }
            page.drawText(`- ${name}`, { x: 70, y, size: 12 });
            y -= 20;
          }
        }

        updateProgress(40, 'Merging receipts…');
        const A4 = { w: 595.28, h: 841.89 };
        for (const entry of receiptEntries) {
          const fileInput = entry.querySelector('input[type="file"]');
          if (!fileInput || fileInput.files.length === 0) continue;
          const file = fileInput.files[0];
          const nameLower = file.name.toLowerCase();
          const isPdf = file.type === 'application/pdf' || nameLower.endsWith('.pdf');

          if (isPdf) {
            const bytes = await file.arrayBuffer();
            const srcPdf = await PDFDocument.load(bytes);
            const pages = await mergedPdf.copyPages(srcPdf, srcPdf.getPageIndices());
            pages.forEach(p => mergedPdf.addPage(p));
          } else if (file.type.startsWith('image/')) {
            const imgBytes = await file.arrayBuffer();
            let img;
            if (/jpe?g$/i.test(nameLower)) img = await mergedPdf.embedJpg(imgBytes);
            else img = await mergedPdf.embedPng(imgBytes);

            const imgW = img.width, imgH = img.height;
            const scale = Math.min(A4.w / imgW, A4.h / imgH);
            const drawW = imgW * scale, drawH = imgH * scale;
            const page = mergedPdf.addPage([A4.w, A4.h]);
            const x = (A4.w - drawW) / 2;
            const y = (A4.h - drawH) / 2;
            page.drawImage(img, { x, y, width: drawW, height: drawH });
          }
        }

        updateProgress(70, 'Encoding…');
        const mergedPdfBytes = await mergedPdf.save();
        const mergedPdfBase64 = uint8ArrayToBase64(mergedPdfBytes);

        // payload
        const fd = new FormData();
        const formData = new FormData(form);
        for (const [k, v] of formData.entries()) { if (typeof v !== 'object') fd.append(k, v); }
        fd.append("reference", ref);
        fd.append("receiptCount", receiptIndex);
        fd.append("fileBase64", mergedPdfBase64);
        fd.append("fileName", `Consolidated_Receipts_${ref}.pdf`);
        fd.append("fileMimeType", "application/pdf");

        updateProgress(90, 'Sending…');
        fetch(SCRIPT_URL, { method: "POST", body: fd, mode: 'no-cors' })
          .catch((err) => {
            console.error("Fetch failed to send:", err);
            resetSubmit();
            document.getElementById('referenceNumber').innerText = '❌ Submission failed. Please try again.';
          });

        updateProgress(100, '');
        document.getElementById('progressContainer').classList.add('hidden');
        saveDefaultsIfWanted();

        document.getElementById('referenceNumber').innerHTML =
          `✅ Sent!<br><br><strong>Reference:</strong> <span>${ref}</span>`;

        setTimeout(() => {
          form.reset();
          document.getElementById('receipts').innerHTML = '';
          receiptIndex = 0;
          handleFormDisplay();
          toggleTravelSection();
          updateBankUI();
        }, 500);

      } catch (error) {
        console.error("Error before sending:", error);
        updateProgress(100, '');
        document.getElementById('progressContainer').classList.add('hidden');
        document.getElementById('referenceNumber').innerText = '❌ Error while preparing files. Please try again.';
        submitButton.disabled = false;
      }

      function updateProgress(percent){ document.getElementById('progressBar').style.width = percent + '%'; }
    });

    function updateProgress(percent){ document.getElementById('progressBar').style.width = percent + '%'; }

    function uint8ArrayToBase64(bytes) {
      let binary = '';
      const chunk = 0x8000;
      for (let i = 0; i < bytes.length; i += chunk) {
        const sub = bytes.subarray(i, i + chunk);
        binary += String.fromCharCode.apply(null, sub);
      }
      return btoa(binary);
    }

// ---------- Drag & Drop for receipts ----------
function initDropzone(){
  const dz = document.getElementById('dropzone');
  const filePicker = document.getElementById('dzFile');
  if(!dz || !filePicker) return;

  // allow click to open system picker
  filePicker.addEventListener('change', (e)=>{
    if(!e.target.files || !e.target.files.length) return;
    handleDroppedFiles(e.target.files);
    // reset so picking same file again still fires change
    e.target.value = '';
  });

  // prevent browser from opening files
  ['dragenter','dragover','dragleave','drop'].forEach(evt=>{
    dz.addEventListener(evt, (e)=>{ e.preventDefault(); e.stopPropagation(); }, false);
  });

  dz.addEventListener('dragover', ()=> dz.classList.add('dragover'));
  dz.addEventListener('dragenter', ()=> dz.classList.add('dragover'));
  dz.addEventListener('dragleave', ()=> dz.classList.remove('dragover'));
  dz.addEventListener('drop', (e)=>{
    dz.classList.remove('dragover');
    const files = e.dataTransfer?.files;
    if(files && files.length) handleDroppedFiles(files);
  });
}

// Take a FileList and create one receipt per file, attaching each file to its input
function handleDroppedFiles(fileList){
  const allowed = ['application/pdf','image/jpeg','image/png'];
  const maxReceipts = typeof window.maxReceipts === 'number' ? window.maxReceipts : 16;

  const files = Array.from(fileList).filter(f=>{
    const ext = f.name.toLowerCase();
    return allowed.includes(f.type) ||
           ext.endsWith('.pdf') || ext.endsWith('.jpg') || ext.endsWith('.jpeg') || ext.endsWith('.png');
  });

  if (!files.length) { alert('Only PDF, JPG, or PNG are accepted.'); return; }

  for (const file of files){
    if (window.receiptIndex >= maxReceipts){
      alert(`You reached the maximum of ${maxReceipts} receipts.`);
      break;
    }
    // Capture the index that addReceipt() will use
    const idx = window.receiptIndex;
    addReceipt(); // this increments receiptIndex internally, builds the DOM

    // attach the dropped file to that new receipt's file input
    attachFileToReceiptInput(idx, file);
    }
  }

  // if any new Travel types get selected later, existing toggleTravelSection() will handle it

// Initialize after DOM and your form bootstrap
document.addEventListener('DOMContentLoaded', initDropzone);

function decorateReceiptFileInput(i){
  const input = document.getElementById(`receiptFile${i}`);
  const chip  = document.getElementById(`fileChip${i}`);
  if(!input || !chip) return;

  input.addEventListener('change', ()=>{
    if (input.files && input.files.length){
      const f = input.files[0];
      chip.innerHTML = `
        <span>${f.name}</span>
        <button type="button" onclick="document.getElementById('receiptFile${i}').click()">Change</button>
      `;
      chip.classList.remove('hidden');
    } else {
      chip.classList.add('hidden');
      chip.innerHTML = '';
    }
  });
}

function attachFileToReceiptInput(idx, file){
  const input = document.getElementById(`receiptFile${idx}`);
  if(!input) return;

  // Programmatically set the FileList
  const dt = new DataTransfer();
  dt.items.add(file);
  input.files = dt.files;

  // Fire change so browser validity + our chip update
  input.dispatchEvent(new Event('change', { bubbles:true }));
}

  </script>

</body>
</html>
