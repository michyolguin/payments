<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Reimbursement Portal</title>
  <script src="https://unpkg.com/pdf-lib"></script>
  <style>
    body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; margin: 2rem; background-color: #f4f4f9; color: #333; }
    h1, h2, h3 { color: #2c3e50; }
    .hidden { display: none; }
    .form-section, .receipt-entry { margin-bottom: 1.5rem; padding: 1.5rem; border: 1px solid #ddd; border-radius: 8px; background-color: #fff; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
    label { display: block; margin-top: 1rem; font-weight: bold; color: #555; }
    input, select, textarea { width: 100%; padding: 0.75rem; margin-top: 0.3rem; border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box; }
    button { background-color: #3498db; color: white; padding: 0.75rem 1.5rem; margin-top: 1rem; border: none; border-radius: 4px; cursor: pointer; font-size: 1rem; transition: background-color 0.3s; }
    .meal-participants { border-top: 1px dashed #ccc; margin-top: 1rem; padding-top: 1rem; }
    .pp-message { margin-top: 0.5rem; font-weight: bold; height: 1em; }
    .pp-ok { color: #2ecc71; } /* Green */
    .pp-warning { color: #e74c3c; } /* Red */
    .ack-box { margin-top: 1rem; padding: 0.75rem; background-color: #fffbe6; border: 1px solid #ffeeba; border-radius: 4px; }
    .ack-box label { font-weight: normal; }
    .ack-box input { width: auto; margin-right: 0.5rem; }
    #referenceNumber { margin-top: 1rem; font-weight: bold; white-space: pre-line; padding: 1rem; border-radius: 4px; text-align: center; }
    #progressContainer { width: 100%; background-color: #e0e0e0; border-radius: 4px; margin-top: 1rem; overflow: hidden; }
    #progressBar { width: 0%; height: 24px; background-color: #3498db; border-radius: 4px; text-align: center; color: white; line-height: 24px; transition: width 0.4s ease; }
  </style>
</head>
<body>
  <h1>Reimbursement Portal</h1>
  
  <div id="form">
    <h2>Submit New Reimbursement Request</h2>
    <form id="reimbursementForm">
      <div class="form-section">
        <label for="employeeStatus">Are you employed by the institute?</label>
        <select id="employeeStatus" name="employeeStatus" required onchange="handleFormDisplay()">
          <option value="" disabled selected>Please select an option</option>
          <option value="yes">Yes (Internal Reimbursement)</option>
          <option value="no">No (External Reimbursement)</option>
        </select>
      </div>

      <div id="commonInfoSection" class="form-section hidden">
        <label>Full Name</label><input type="text" name="fullName" required>
        <label>Email Address</label><input type="email" name="email" required>
        <label>Project Lead or Project Name</label><input list="projectNumbers" name="project" required><datalist id="projectNumbers"><option value="Christine LUTRINGER – AHCD 2025 – P0189"><option value="Vincent CHETAIL – NCCR / Migration Governance – S2334"></datalist>
        <label>Reason for Reimbursement</label><textarea name="reimbursementReason" required></textarea>
        <label>Your Address</label><textarea name="address"></textarea>
      </div>

      <div id="bankDetailsSection" class="form-section hidden">
        <h3>Bank Details</h3>
        <label>IBAN</label><input type="text" name="iban">
        <label>Bank Account Number (non-IBAN)</label><input type="text" name="accountNumber">
        <label>Bank Code</label><input type="text" name="bankCode">
        <label>Bank Name</label><input type="text" name="bankName">
      </div>
      
      <div id="receiptsSection" class="hidden">
        <h3>Receipts (Max 16)</h3>
        <div id="receipts"></div>
        <button type="button" onclick="addReceipt()">Add Receipt</button>
      </div>
      
      <div id="submitSection" class="hidden">
        <br><button type="submit">Submit</button>
        <div id="progressContainer" class="hidden"><div id="progressBar"></div></div>
        <div id="referenceNumber"></div>
      </div>
    </form>
  </div>

  <script>
    const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbzzimaL8zfTDCPUXC1mpU0og_k9WPiH9zhZgcchu87OiqO1vwpnxOl0RJz_Hxj5Q_nJ0g/exec"; // Replace with your current URL
    let receiptIndex = 0;
    const maxReceipts = 16;
    const { PDFDocument, rgb, StandardFonts } = PDFLib;

    function handleFormDisplay() {
      const status = document.getElementById('employeeStatus').value;
      const commonInfo = document.getElementById('commonInfoSection');
      const bankSection = document.getElementById('bankDetailsSection');
      const receiptsSection = document.getElementById('receiptsSection');
      const submitSection = document.getElementById('submitSection');
      if (status) {
        commonInfo.classList.remove('hidden');
        receiptsSection.classList.remove('hidden');
        submitSection.classList.remove('hidden');
        if (status === 'no') {
          bankSection.classList.remove('hidden');
        } else {
          bankSection.classList.add('hidden');
        }
      }
    }
    
    function addReceipt() {
      if (receiptIndex >= maxReceipts) {
        alert(`Maximum of ${maxReceipts} receipts allowed.`);
        return;
      }
      const r_index = receiptIndex;
      const container = document.createElement('div');
      container.classList.add('receipt-entry');
      container.id = `receipt-entry-${r_index}`;
      container.innerHTML = `
        <h4>Receipt ${r_index + 1}</h4>
        <label>Upload Receipt PDF</label><input type="file" name="receiptFile${r_index}" accept=".pdf" required>
        <label>Date</label><input type="date" name="date${r_index}" required>
        <label>Expense Type</label>
        <select name="type${r_index}" onchange="handleExpenseTypeChange(${r_index})" required>
          <option value="">Select a type</option><option value="Travel">Travel</option><option value="Accommodation">Accommodation</option><option value="Meals">Meals</option><option value="Supplies">Supplies</option><option value="Honorarium">Honorarium</option><option value="Other">Other</option>
        </select>
        <div id="meal-participants-${r_index}" class="meal-participants hidden"></div>
        <label>Currency</label><input type="text" name="currency${r_index}" placeholder="e.g., CHF" required>
        <label>Amount</label><input type="number" name="amount${r_index}" step="0.01" oninput="calculateMealsAverage(${r_index})" required>
        <div id="pp-message-${r_index}" class="pp-message"></div>
        <div id="ack-box-${r_index}" class="ack-box hidden">
          <input type="checkbox" id="ack-checkbox-${r_index}" name="ack_limit_${r_index}" required>
          <label for="ack-checkbox-${r_index}">I acknowledge that reimbursement for this meal will be capped at the institutional regulatory limit.</label>
        </div>
      `;
      document.getElementById('receipts').appendChild(container);
      receiptIndex++;
    }

    function handleExpenseTypeChange(index) {
      const expenseType = document.querySelector(`select[name="type${index}"]`).value;
      const mealSection = document.getElementById(`meal-participants-${index}`);
      if (expenseType === 'Meals') {
        mealSection.classList.remove('hidden');
        mealSection.innerHTML = `
          <label>Number of Participants</label>
          <input type="number" name="participants_count${index}" min="1" oninput="generateParticipantFields(${index})">
          <div id="participant-names-${index}"></div>
        `;
      } else {
        mealSection.classList.add('hidden');
        mealSection.innerHTML = '';
      }
      calculateMealsAverage(index);
    }

    function generateParticipantFields(index) {
      const count = parseInt(document.querySelector(`input[name="participants_count${index}"]`).value, 10);
      const namesContainer = document.getElementById(`participant-names-${index}`);
      namesContainer.innerHTML = '';
      if (count > 0) {
        let fieldsHTML = '<label>Participant Names</label>';
        for (let i = 0; i < count; i++) {
          fieldsHTML += `<input type="text" name="participant_${index}_name_${i}" placeholder="Participant ${i+1}" required>`;
        }
        namesContainer.innerHTML = fieldsHTML;
      }
      calculateMealsAverage(index);
    }

    function calculateMealsAverage(index) {
      const messageDiv = document.getElementById(`pp-message-${index}`);
      const ackBox = document.getElementById(`ack-box-${index}`);
      const expenseType = document.querySelector(`select[name="type${index}"]`).value;

      if (expenseType !== 'Meals') {
        messageDiv.className = 'pp-message';
        messageDiv.innerText = '';
        ackBox.classList.add('hidden');
        return;
      }

      const amountInput = document.querySelector(`input[name="amount${index}"]`);
      const participantsInput = document.querySelector(`input[name="participants_count${index}"]`);
      
      if (!amountInput || !participantsInput) { ackBox.classList.add('hidden'); return; }
      
      const amount = parseFloat(amountInput.value);
      const participants = parseInt(participantsInput.value, 10);

      if (amount > 0 && participants > 0) {
        const average = amount / participants;
        messageDiv.innerText = `Per-person average: ${average.toFixed(2)}`;
        if (average > 60) {
          messageDiv.className = 'pp-message pp-warning';
          messageDiv.innerText += ` (Exceeds the per-person regulation limit)`;
          ackBox.classList.remove('hidden');
        } else {
          messageDiv.className = 'pp-message pp-ok';
          ackBox.classList.add('hidden');
        }
      } else {
        messageDiv.innerText = '';
        ackBox.classList.add('hidden');
      }
    }

    // All other JavaScript functions (updateProgress, uint8ArrayToBase64, form submission) remain the same
    // ...
  </script>
</body>
</html>
