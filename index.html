<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Reimbursement Portal</title>
  <script src="https://unpkg.com/pdf-lib"></script>
  <script src="https://cdn.jsdelivr.net/npm/iban/dist/iban.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/tesseract.js@5.0.1/dist/tesseract.min.js"></script>
  <style>
    body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; margin: 2rem; background-color: #f4f4f9; color: #333; }
    h1, h2, h3 { color: #2c3e50; }
    .hidden { display: none; }
    .form-section, .receipt-entry { margin-bottom: 1.5rem; padding: 1.5rem; border: 1px solid #ddd; border-radius: 8px; background-color: #fff; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
    label { display: block; margin-top: 1rem; font-weight: bold; color: #555; }
    input, select, textarea { width: 100%; padding: 0.75rem; margin-top: 0.3rem; border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box; }
    input:disabled { background-color: #f0f0f0; cursor: not-allowed; }
    button { background-color: #3498db; color: white; padding: 0.75rem 1.5rem; margin-top: 1rem; border: none; border-radius: 4px; cursor: pointer; font-size: 1rem; transition: background-color 0.3s; }
    .validation-message { font-size: 0.9em; margin-top: 0.3rem; min-height: 1em; color: #555; }
    .pp-message { margin-top: 0.5rem; font-weight: bold; min-height: 1em; }
    .pp-ok { color: #2ecc71; }
    .pp-warning { color: #e74c3c; }
    .ack-box { margin-top: 1rem; padding: 0.75rem; background-color: #fffbe6; border: 1px solid #ffeeba; border-radius: 4px; }
    .ack-box label { font-weight: normal; font-size: 0.9em; }
    .ack-box input { width: auto; margin-right: 0.5rem; }
    #referenceNumber { margin-top: 1rem; font-weight: bold; white-space: pre-line; padding: 1rem; border-radius: 4px; text-align: center; }
    #progressContainer { width: 100%; background-color: #e0e0e0; border-radius: 4px; margin-top: 1rem; overflow: hidden; }
    #progressBar { width: 0%; height: 24px; background-color: #3498db; border-radius: 4px; text-align: center; color: white; line-height: 24px; transition: width 0.4s ease; }
  </style>
</head>
<body>
  <h1>Reimbursement Portal</h1>
  
  <div id="form">
    <h2>Submit New Reimbursement Request</h2>
    <!-- ENABLE BROWSER AUTOFILL -->
    <form id="reimbursementForm" autocomplete="on">
      <div class="form-section">
        <label for="employeeStatus">Are you employed by the institute?</label>
        <select id="employeeStatus" name="employeeStatus" required onchange="handleFormDisplay()">
          <option value="" disabled selected>Please select an option</option>
          <option value="yes">Yes (Internal Reimbursement)</option>
          <option value="no">No (External Reimbursement)</option>
        </select>
      </div>

      <div id="commonInfoSection" class="form-section hidden">
        <label>Full Name</label>
        <input type="text" name="fullName" autocomplete="name" required>

        <label>Email Address</label>
        <input type="email" name="email" autocomplete="email" required>

        <label>Reason for Reimbursement</label>
        <textarea name="reimbursementReason" rows="3" required placeholder="Why are you claiming these expenses?"></textarea>

        <label>Project Lead or Project Name</label>
        <input list="projectNumbers" name="project" required autocomplete="organization">
        <datalist id="projectNumbers">
          <option value="Christine LUTRINGER – AHCD 2025 – P0189">
          <option value="Vincent CHETAIL – NCCR / Migration Governance – S2334">
        </datalist>

        <label>Your Address</label>
        <textarea name="address" rows="3" autocomplete="street-address"></textarea>
      </div>

      <div id="bankDetailsSection" class="form-section hidden">
        <h3>Bank Details</h3>

        <label>IBAN</label>
        <input type="text" name="iban" id="ibanInput" inputmode="text" autocapitalize="characters" autocomplete="off" placeholder="e.g., CH9300762011623852957">
        <div id="ibanValidation" class="validation-message"></div>

        <label>Bank Account Number (non-IBAN)</label>
        <input type="text" name="accountNumber" id="accountInput" inputmode="numeric" autocomplete="off">

        <label>BIC/SWIFT Code</label>
        <input type="text" name="bankCode"
               pattern="[A-Za-z]{4}[A-Za-z]{2}[A-Za-z0-9]{2}([A-Za-z0-9]{3})?"
               title="Must be a valid 8 or 11 character BIC/SWIFT code."
               autocapitalize="characters" autocomplete="off">

        <label>Bank Name and Address</label>
        <input type="text" name="bankName" id="bankAddressInput" autocomplete="organization">
        <div id="bankAddressValidation" class="validation-message"></div>
      </div>

      <div id="receiptsSection" class="hidden">
        <h3>Receipts (Max 16)</h3>
        <div id="receipts"></div>
        <button type="button" onclick="addReceipt()">Add Receipt</button>
      </div>

      <!-- Travel section (only shows if any receipt type is Travel) -->
      <div id="travelSection" class="form-section hidden">
        <h3>Travel declaration (only if you had travel expenses)</h3>
        <label><input type="radio" name="planeReason" value="Train" checked> I took the train</label>
        <label><input type="radio" name="planeReason" value="Train>7h"> I took a plane as the travel by train takes more than 7h</label>
        <label><input type="radio" name="planeReason" value="Exception"> I took a plane in Europe for a travel lasting less than 7 hours, because of the following exception:</label>
        <div id="travelExceptionBox" class="hidden" style="margin-top:.5rem">
          <select name="planeException">
            <option value="">Select an exception…</option>
            <option>Health impairments of the person travelling</option>
            <option>Reconciling care responsibilities and work</option>
            <option>Safety considerations due to particular events</option>
            <option>Teaching and/or administrative constraints</option>
            <option>Cases of force majeure</option>
            <option>For PhD students only: significant price differences</option>
          </select>
        </div>
      </div>
      
      <div id="submitSection" class="hidden">
        <div class="ack-box" style="margin-top:.25rem;">
          <label><input type="checkbox" id="rememberMe"> Remember my name, email, and address on this device</label>
        </div>

        <br><button type="submit">Submit</button>
        <div id="progressContainer" class="hidden"><div id="progressBar"></div></div>
        <div id="referenceNumber"></div>
      </div>
    </form>
  </div>

  <script>
    // Use your currently working deployment:
    const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbxMF5kj5Ap3fQhESi2Ie0jvccVlk0xW8FvVtuwSePXUhPJdEeY0WXgfVXExq6oQQBQwyg/exec";

    let receiptIndex = 0;
    const maxReceipts = 16;
    const { PDFDocument, rgb, StandardFonts } = PDFLib;

    // Restore remembered fields on load (safe subset: name/email/address only)
    document.addEventListener('DOMContentLoaded', () => {
      try {
        const saved = JSON.parse(localStorage.getItem('reimb_user_defaults') || '{}');
        if (saved.fullName) document.querySelector('input[name="fullName"]').value = saved.fullName;
        if (saved.email) document.querySelector('input[name="email"]').value = saved.email;
        if (saved.address) document.querySelector('textarea[name="address"]').value = saved.address;
      } catch {}
    });

    function saveDefaultsIfWanted() {
      const remember = document.getElementById('rememberMe')?.checked;
      if (!remember) return;
      const payload = {
        fullName: document.querySelector('input[name="fullName"]').value || '',
        email: document.querySelector('input[name="email"]').value || '',
        address: document.querySelector('textarea[name="address"]').value || ''
      };
      localStorage.setItem('reimb_user_defaults', JSON.stringify(payload));
    }

    function handleFormDisplay() {
      const status = document.getElementById('employeeStatus').value;
      const commonInfo = document.getElementById('commonInfoSection');
      const bankSection = document.getElementById('bankDetailsSection');
      const receiptsSection = document.getElementById('receiptsSection');
      const submitSection = document.getElementById('submitSection');
      if (status) {
        commonInfo.classList.remove('hidden');
        receiptsSection.classList.remove('hidden');
        submitSection.classList.remove('hidden');
        if (status === 'no') {
          bankSection.classList.remove('hidden');
        } else {
          bankSection.classList.add('hidden');
        }
      }
    }
    
    function addReceipt() {
      if (receiptIndex >= maxReceipts) {
        alert(`Maximum of ${maxReceipts} receipts allowed.`);
        return;
      }
      const r_index = receiptIndex;
      const container = document.createElement('div');
      container.classList.add('receipt-entry');
      container.id = `receipt-entry-${r_index}`;
      container.innerHTML = `
        <h4>Receipt ${r_index + 1}</h4>
        <label>Upload Receipt (PDF, JPG, PNG)</label>
        <input type="file" name="receiptFile${r_index}" accept=".pdf,.jpg,.jpeg,.png" required>

        <label>Date</label>
        <input type="date" name="date${r_index}" required>

        <label>Expense Type</label>
        <select name="type${r_index}" onchange="handleExpenseTypeChange(${r_index})" required>
          <option value="">Select a type</option>
          <option value="Travel">Travel</option>
          <option value="Accommodation">Accommodation</option>
          <option value="Meals">Meals</option>
          <option value="Supplies">Supplies</option>
          <option value="Honorarium">Honorarium</option>
          <option value="Other">Other</option>
        </select>

        <div id="meal-participants-${r_index}" class="meal-participants hidden"></div>

        <label>Currency</label>
        <input type="text" name="currency${r_index}" autocomplete="off" placeholder="e.g., CHF" required>

        <label>Amount</label>
        <input type="number" name="amount${r_index}" inputmode="decimal" step="0.01" oninput="calculateMealsAverage(${r_index})" required>

        <button type="button" onclick="scanReceipt(${r_index})">🧠 Scan for total</button>
        <div id="scan-msg-${r_index}" class="validation-message"></div>

        <div id="pp-message-${r_index}" class="pp-message"></div>
        <div id="ack-box-${r_index}" class="ack-box hidden">
          <input type="checkbox" id="ack-checkbox-${r_index}" name="ack_limit_${r_index}">
          <label for="ack-checkbox-${r_index}">I acknowledge that the reimbursement for this meal will be capped at the Graduate Institute's maximum per-person rate.</label>
        </div>
      `;
      document.getElementById('receipts').appendChild(container);
      receiptIndex++;
      toggleTravelSection();
    }

    function handleExpenseTypeChange(index) {
      calculateMealsAverage(index);
      toggleTravelSection();
      const expenseType = document.querySelector(`select[name="type${index}"]`).value;
      const mealSection = document.getElementById(`meal-participants-${index}`);
      if (expenseType === 'Meals') {
        mealSection.classList.remove('hidden');
        mealSection.innerHTML = `
          <label>Number of Participants</label>
          <input type="number" name="participants_count${index}" min="1" oninput="generateParticipantFields(${index})">
          <div id="participant-names-${index}"></div>
        `;
      } else {
        mealSection.classList.add('hidden');
        mealSection.innerHTML = '';
      }
    }

    function generateParticipantFields(index) {
      const count = parseInt(document.querySelector(`input[name="participants_count${index}"]`).value, 10);
      const namesContainer = document.getElementById(`participant-names-${index}`);
      namesContainer.innerHTML = '';
      if (count > 0) {
        let fieldsHTML = '<label>Participant Names</label>';
        for (let i = 0; i < count; i++) {
          fieldsHTML += `<input type="text" name="participant_${index}_name_${i}" placeholder="Participant ${i+1}" required>`;
        }
        namesContainer.innerHTML = fieldsHTML;
      }
      calculateMealsAverage(index);
    }

    function calculateMealsAverage(index) {
      const messageDiv = document.getElementById(`pp-message-${index}`);
      const ackBox = document.getElementById(`ack-box-${index}`);
      const ackCheckbox = document.getElementById(`ack-checkbox-${index}`);
      const expenseType = document.querySelector(`select[name="type${index}"]`).value;
      
      if (expenseType !== 'Meals') {
        messageDiv.className = 'pp-message';
        messageDiv.innerText = '';
        ackBox.classList.add('hidden');
        ackCheckbox.required = false;
        return;
      }

      const amountInput = document.querySelector(`input[name="amount${index}"]`);
      const participantsInput = document.querySelector(`input[name="participants_count${index}"]`);
      
      if (!amountInput || !participantsInput) { 
        ackBox.classList.add('hidden'); 
        ackCheckbox.required = false; 
        return; 
      }
      
      const amount = parseFloat(amountInput.value);
      const participants = parseInt(participantsInput.value, 10);

      if (amount > 0 && participants > 0) {
        const average = amount / participants;
        messageDiv.innerText = `Per-person average: ${average.toFixed(2)}`;
        if (average > 60) {
          messageDiv.className = 'pp-message pp-warning';
          messageDiv.innerText += ` (Note: This exceeds the institutional regulatory limit.)`;
          ackBox.classList.remove('hidden');
          ackCheckbox.required = true;
        } else {
          messageDiv.className = 'pp-message pp-ok';
          ackBox.classList.add('hidden');
          ackCheckbox.required = false;
        }
      } else {
        messageDiv.innerText = '';
        ackBox.classList.add('hidden');
        ackCheckbox.required = false;
      }
    }

    function toggleTravelSection() {
      const entries = Array.from(document.querySelectorAll('.receipt-entry'));
      const anyTravel = entries.some((entry, idx) => {
        const sel = entry.querySelector(`select[name="type${idx}"]`);
        return sel && sel.value === 'Travel';
      });

      const travel = document.getElementById('travelSection');
      const radios = document.querySelectorAll('input[name="planeReason"]');
      const exceptionBox = document.getElementById('travelExceptionBox');

      if (anyTravel) {
        travel.classList.remove('hidden');
        const selected = Array.from(radios).find(r => r.checked)?.value || 'Train';
        exceptionBox.classList.toggle('hidden', selected !== 'Exception');
      } else {
        travel.classList.add('hidden');
      }
    }

    document.addEventListener('change', (e) => {
      if (e.target && e.target.name === 'planeReason') {
        document.getElementById('travelExceptionBox')
          .classList.toggle('hidden', e.target.value !== 'Exception');
      }
    });

    function updateProgress(percent, message) {
      const bar = document.getElementById('progressBar');
      const box = document.getElementById('progressContainer');
      box.classList.remove('hidden');
      bar.style.width = percent + '%';
      bar.textContent = message || '';
    }

    function uint8ArrayToBase64(bytes) {
      let binary = '';
      const chunk = 0x8000;
      for (let i = 0; i < bytes.length; i += chunk) {
        const sub = bytes.subarray(i, i + chunk);
        binary += String.fromCharCode.apply(null, sub);
      }
      return btoa(binary);
    }
    
    function handleIBANInput() {}
    function handleAccountInput() {}
    function validateBankAddress() {}

    // ---------------------
    // OCR: Scan for totals
    // ---------------------
    async function scanReceipt(index) {
      const msg = document.getElementById(`scan-msg-${index}`);
      msg.textContent = '';

      // get file
      const entry = document.getElementById(`receipt-entry-${index}`);
      const fileInput = entry?.querySelector(`input[name="receiptFile${index}"]`);
      if (!fileInput || fileInput.files.length === 0) {
        msg.textContent = 'Please choose a receipt file first.';
        return;
      }
      const file = fileInput.files[0];

      // Only scan images for now
      if (file.type === 'application/pdf' || file.name.toLowerCase().endsWith('.pdf')) {
        msg.textContent = 'For scanning, please upload a JPG/PNG (PDF scan coming soon).';
        return;
      }
      if (!file.type.startsWith('image/')) {
        msg.textContent = 'Unsupported file type. Please upload a JPG or PNG.';
        return;
      }

      // UI
      const scanButton = entry.querySelector('button[onclick^="scanReceipt("]');
      const prevLabel = scanButton.textContent;
      scanButton.disabled = true;
      scanButton.textContent = 'Scanning… (this may take ~5–10s)';
      msg.textContent = '';

      try {
        // Read image as dataURL
        const dataUrl = await new Promise((resolve, reject) => {
          const reader = new FileReader();
          reader.onload = () => resolve(reader.result);
          reader.onerror = reject;
          reader.readAsDataURL(file);
        });

        // Run OCR
        const { createWorker } = Tesseract;
        const worker = await createWorker('eng', 1, {
          logger: m => {
            if (m.status === 'recognizing text' && m.progress != null) {
              msg.textContent = `Scanning… ${Math.round(m.progress * 100)}%`;
            }
          }
        });

        const result = await worker.recognize(dataUrl);
        await worker.terminate();

        const text = (result && result.data && result.data.text) ? result.data.text : '';
        if (!text.trim()) {
          msg.textContent = 'No text detected. Try a clearer photo.';
          return;
        }

        // Parse amount + currency
        const { currencyGuess, amountGuess, debugNote } = extractTotalFromText(text);

        // Fill inputs
        const currencyInput = entry.querySelector(`input[name="currency${index}"]`);
        const amountInput = entry.querySelector(`input[name="amount${index}"]`);

        if (currencyGuess) currencyInput.value = currencyGuess;
        if (amountGuess != null) amountInput.value = amountGuess.toFixed(2);

        if (amountGuess == null) {
          msg.textContent = 'Couldn’t confidently find a total. Please enter it manually.';
        } else {
          msg.textContent = `Suggested total: ${currencyInput.value || ''} ${amountGuess.toFixed(2)}${debugNote ? ' • ' + debugNote : ''}`;
          calculateMealsAverage(index);
        }

      } catch (err) {
        console.error('OCR error:', err);
        msg.textContent = 'Scan failed. Try a clearer image.';
      } finally {
        scanButton.disabled = false;
        scanButton.textContent = prevLabel;
      }
    }

    function extractTotalFromText(text) {
      const t = text.replace(/\u00A0/g, ' ').replace(/[,，]/g, '.'); // normalize spaces/commas
      const currencyTokens = ['CHF', 'SFR', 'FR', 'EUR', '€', 'USD', '\\$','GBP','£'];

      // “total” hints
      const totalHints = /(grand\s*total|amount\s*due|total\s*to\s*pay|total|balance\s*due)/i;
      const lines = t.split(/\r?\n/).map(l => l.trim()).filter(Boolean);

      let bestCurrency = null;
      let bestAmount = null;

      // helper: first money-like number on a line
      const moneyOnLine = (line) => {
        const moneyRegex = new RegExp(`(?:(${currencyTokens.join('|')})\\s*)?(\\d{1,3}(?:\\.\\d{3})*(?:\\.\\d{2})|\\d+\\.\\d{2})(?:\\s*(${currencyTokens.join('|')}))?`, 'i');
        const m = line.match(moneyRegex);
        if (!m) return null;
        const leftCur = m[1];
        const numStr = m[2];
        const rightCur = m[3];
        const cur = (leftCur || rightCur || '').toUpperCase().replace(/[^A-Z€$£]/g,'');
        const amt = parseFloat(numStr);
        return { cur, amt };
      };

      // Pass A: look for lines mentioning total
      for (const line of lines) {
        if (totalHints.test(line)) {
          const found = moneyOnLine(line);
          if (found) {
            bestCurrency = normalizeCurrency(found.cur) || bestCurrency;
            bestAmount = found.amt;
            return { currencyGuess: bestCurrency || guessCurrencyFromText(t) || 'CHF', amountGuess: bestAmount, debugNote: 'from “total” line' };
          }
        }
      }

      // Pass B: take largest amount
      let maxFound = { amt: -1, cur: null };
      for (const line of lines) {
        const found = moneyOnLine(line);
        if (found && found.amt > maxFound.amt) maxFound = found;
      }
      if (maxFound.amt > 0) {
        bestCurrency = normalizeCurrency(maxFound.cur) || guessCurrencyFromText(t) || 'CHF';
        bestAmount = maxFound.amt;
        return { currencyGuess: bestCurrency, amountGuess: bestAmount, debugNote: 'largest amount found' };
      }

      return { currencyGuess: guessCurrencyFromText(t) || null, amountGuess: null, debugNote: null };
    }

    function normalizeCurrency(cur) {
      if (!cur) return null;
      const c = cur.toUpperCase();
      if (c.includes('CHF') || c.includes('SFR') || c === 'FR') return 'CHF';
      if (c.includes('EUR') || c.includes('€')) return 'EUR';
      if (c.includes('USD') || c.includes('$')) return 'USD';
      if (c.includes('GBP') || c.includes('£')) return 'GBP';
      return null;
    }

    function guessCurrencyFromText(text) {
      const u = text.toUpperCase();
      if (u.includes('CHF') || u.includes('SFR')) return 'CHF';
      if (u.includes('EUR') || u.includes('€')) return 'EUR';
      if (u.includes('USD') || u.includes('$')) return 'USD';
      if (u.includes('GBP') || u.includes('£')) return 'GBP';
      return null;
    }
    // ---------------------

    document.getElementById('reimbursementForm').addEventListener('submit', async function (e) {
      e.preventDefault();
      const form = e.target;
      const ref = 'REF' + Date.now();
      const referenceBox = document.getElementById('referenceNumber');
      const progressContainer = document.getElementById('progressContainer');
      const submitButton = form.querySelector('button[type="submit"]');
      submitButton.disabled = true;
      progressContainer.classList.remove('hidden');
      updateProgress(0, 'Starting...');

      try {
        updateProgress(10, 'Processing & generating participant page...');
        const mergedPdf = await PDFDocument.create();
        const font = await mergedPdf.embedFont(StandardFonts.Helvetica);

        // participant page (if any Meals)
        let hasMealExpenses = false;
        const allParticipants = [];
        const receiptEntries = document.querySelectorAll('.receipt-entry');
        receiptEntries.forEach((entry, index) => {
          const expenseType = entry.querySelector(`select[name="type${index}"]`).value;
          if (expenseType === 'Meals') {
            hasMealExpenses = true;
            const participantCount = parseInt(entry.querySelector(`input[name="participants_count${index}"]`)?.value || '0', 10);
            for (let i = 0; i < participantCount; i++) {
              const nameInput = entry.querySelector(`input[name="participant_${index}_name_${i}"]`);
              if (nameInput && nameInput.value) allParticipants.push(nameInput.value);
            }
          }
        });

        if (hasMealExpenses) {
          let participantsPage = mergedPdf.addPage();
          const { height } = participantsPage.getSize();
          let y = height - 70;
          participantsPage.drawText('Meal Participants', { x: 50, y: y, font, size: 24, color: rgb(0, 0, 0) });
          y -= 40;
          allParticipants.forEach(name => {
            if (y < 50) {
              participantsPage = mergedPdf.addPage();
              y = height - 70;
            }
            participantsPage.drawText(`- ${name}`, { x: 70, y: y, font, size: 12, color: rgb(0, 0, 0) });
            y -= 20;
          });
        }

        updateProgress(40, 'Merging receipts...');
        const A4 = { w: 595.28, h: 841.89 }; // pt units (72 dpi)
        for (const entry of receiptEntries) {
          const fileInput = entry.querySelector('input[type="file"]');
          if (!fileInput || fileInput.files.length === 0) continue;

          const file = fileInput.files[0];
          const nameLower = file.name.toLowerCase();
          const isPdf = file.type === 'application/pdf' || nameLower.endsWith('.pdf');

          if (isPdf) {
            // Merge PDF pages directly
            const bytes = await file.arrayBuffer();
            const srcPdf = await PDFDocument.load(bytes);
            const pages = await mergedPdf.copyPages(srcPdf, srcPdf.getPageIndices());
            pages.forEach(p => mergedPdf.addPage(p));
          } else if (file.type.startsWith('image/')) {
            // Embed image as a full page (scaled to A4 while preserving aspect ratio)
            const imgBytes = await file.arrayBuffer();
            let img;
            if (file.type === 'image/jpeg' || nameLower.endsWith('.jpg') || nameLower.endsWith('.jpeg')) {
              img = await mergedPdf.embedJpg(imgBytes);
            } else {
              img = await mergedPdf.embedPng(imgBytes);
            }

            const imgW = img.width;
            const imgH = img.height;

            const scale = Math.min(A4.w / imgW, A4.h / imgH);
            const drawW = imgW * scale;
            const drawH = imgH * scale;

            const page = mergedPdf.addPage([A4.w, A4.h]);
            const x = (A4.w - drawW) / 2;
            const y = (A4.h - drawH) / 2;

            page.drawImage(img, { x, y, width: drawW, height: drawH });
          } else {
            console.warn('Unsupported file type:', file.type || nameLower);
          }
        }
        
        updateProgress(70, 'Preparing data for submission...');
        const mergedPdfBytes = await mergedPdf.save();
        const mergedPdfBase64 = uint8ArrayToBase64(mergedPdfBytes);

        // Build payload
        const fd = new FormData();
        const formData = new FormData(form);
        for (const [k, v] of formData.entries()) {
          if (typeof v !== 'object') fd.append(k, v); // skip File objects (already merged)
        }
        fd.append("reference", ref);
        fd.append("receiptCount", receiptIndex);
        fd.append("fileBase64", mergedPdfBase64);
        fd.append("fileName", `Consolidated_Receipts_${ref}.pdf`);
        fd.append("fileMimeType", "application/pdf");
        
        updateProgress(90, 'Sending...');
        fetch(SCRIPT_URL, { method: "POST", body: fd, mode: 'no-cors' })
          .catch(err => {
            console.error("Fetch failed to send:", err);
            submitButton.disabled = false; 
            progressContainer.classList.add('hidden');
            referenceBox.innerText = '❌ Submission failed. Please check your internet connection and try again.';
          });
        
        updateProgress(100, '');
        progressContainer.classList.add('hidden');

        // SAVE remembered fields (if user opted in)
        saveDefaultsIfWanted();

        referenceBox.innerHTML = `✅ Your request has been sent successfully!<br><br><strong>PLEASE SAVE YOUR REFERENCE NUMBER:</strong><br><span style="font-size: 1.2em; background-color: #d4edda; padding: 5px 10px; border-radius: 4px;">${ref}</span><br><br>You will receive a confirmation email once it has been processed.`;
        
        setTimeout(() => {
          form.reset();
          document.getElementById('receipts').innerHTML = '';
          receiptIndex = 0;
          handleFormDisplay();
          toggleTravelSection();
        }, 500);

      } catch (error) {
        console.error("An error occurred before sending:", error);
        updateProgress(100, ''); 
        progressContainer.classList.add('hidden'); 
        referenceBox.innerText = '❌ An error occurred while preparing your files. Please try again.'; 
        submitButton.disabled = false;
      }
    });
  </script>
</body>
</html>
